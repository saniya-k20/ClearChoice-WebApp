<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Ingredient Analyzer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      padding-bottom: 100px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      color: #FF6B6B;
      font-size: 28px;
    }
    .option-card {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .option-card h2 {
      color: #3B375A;
      margin-top: 0;
    }
    .option-icon {
      font-size: 50px;
      margin-bottom: 15px;
      color: #FF6B6B;
    }
    .upload-btn {
      background-color: #FFD1DC;
      color: #3B375A;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s ease;
    }
    .upload-btn:hover {
      background-color: #FF8CAB;
      color: white;
    }
    /* Camera Modal */
    .camera-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .camera-container {
      width: 90%;
      max-width: 600px;
      position: relative;
    }
    #camera-view {
      width: 100%;
      border-radius: 10px;
    }
    .camera-controls {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .capture-btn {
      background-color: #FF6B6B;
      color: white;
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }
    .close-camera {
      position: absolute;
      top: 15px;
      right: 15px;
      color: white;
      font-size: 30px;
      cursor: pointer;
    }
    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #FF6B6B;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Modern Bottom Navigation Bar */
    .bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-around;
  align-items: center;
  background-color: #ffffff; /* White background */
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); /* Subtle shadow */
  padding: 10px 0; /* Padding for spacing */
  z-index: 1000; /* Ensure it's above other elements */
  height: 70px; /* Slightly taller for a modern look */
  border-top-left-radius: 20px; /* Rounded corners */
  border-top-right-radius: 20px; /* Rounded corners */
}

/* Nav Item Styling */
.bottom-nav .nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-decoration: none;
  color: #a1a4a7; /* Default icon and text color */
  font-size: 12px; /* Smaller font size for modern look */
  font-weight: 500; /* Medium weight for readability */
  padding: 10px 15px; /* Padding for clickable area */
  border-radius: 15px; /* Rounded corners for items */
}

/* Active Nav Item - Only change icon color to pink */
.bottom-nav .nav-item.active i {
  color: #D175A3 !important; /* Pink color for active icon */
}

/* Icon Styling */
.bottom-nav .nav-item i {
  font-size: 24px; /* Larger icon size */
  margin-bottom: 4px; /* Space between icon and text */
}

/* Responsive Design for Mobile */
@media (max-width: 600px) {
  .bottom-nav {
    padding: 8px 0; /* Slightly reduced padding for mobile */
    height: 60px; /* Slightly shorter for mobile */
  }

  .bottom-nav .nav-item {
    font-size: 10px; /* Smaller font size for mobile */
    padding: 8px 12px; /* Smaller padding for mobile */
  }

  .bottom-nav .nav-item i {
    font-size: 20px; /* Slightly smaller icons for mobile */
  }
}
    /* Image Selection Area */
    .image-container {
      position: relative;
      margin: 20px auto;
      max-width: 100%;
      display: none;
    }
    #selectable-image {
      max-width: 100%;
      border-radius: 10px;
      cursor: crosshair;
      touch-action: none;
    }
    .selection-box {
      position: absolute;
      border: 2px dashed #FF6B6B;
      background-color: rgba(255, 107, 107, 0.2);
      pointer-events: none;
      display: none;
    }
    .selection-controls {
      margin-top: 15px;
      display: none;
      justify-content: center;
      gap: 10px;
    }
    .analyze-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
    }
    .reset-btn {
      background-color: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
    }
    .selection-info {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
      color: #666;
      display: none;
    }
    /* Cropped Preview */
    .cropped-preview {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    #cropped-image {
      max-width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Analyze Food Ingredients</h1>
    </div>
    
    <div class="option-card">
      <div class="option-icon">
        <i class="fas fa-images"></i>
      </div>
      <h2>Upload or Take Photo</h2>
      <p>Scan a food label to check ingredients</p>
      
      <input type="file" id="file-upload" accept="image/*" style="display: none;">
      <button class="upload-btn" id="upload-btn">
        <i class="fas fa-upload"></i> Upload Image
      </button>
      
      <button class="upload-btn" id="camera-btn">
        <i class="fas fa-camera"></i> Take Photo
      </button>
      
      <!-- Image Selection Area -->
      <div class="image-container" id="image-container">
        <img id="selectable-image" src="" alt="Food Label">
        <div class="selection-box" id="selection-box"></div>
      </div>
      
      <div class="selection-info" id="selection-info">
        Select the ingredients list area by dragging on the image
      </div>
      
      <div class="selection-controls" id="selection-controls">
        <button class="analyze-btn" id="analyze-btn">
          <i class="fas fa-search"></i> Analyze Text
        </button>
        <button class="reset-btn" id="reset-btn">
          <i class="fas fa-redo"></i> Reset Selection
        </button>
      </div>
      
      <!-- Cropped Preview -->
      <div class="cropped-preview" id="cropped-preview">
        <h3>Selected Area Preview</h3>
        <img id="cropped-image">
      </div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="camera-modal" class="camera-modal">
    <span class="close-camera">&times;</span>
    <div class="camera-container">
      <video id="camera-view" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="capture-btn" class="capture-btn">
          <i class="fas fa-camera"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="spinner"></div>
    <h2>Analyzing Ingredients...</h2>
  </div>

  <!-- Bottom Navigation -->
  <footer class="bottom-nav">
    <a href="favourites.html" class="nav-item">
      <i class="fas fa-heart"></i>
      <span>Favorites</span>
    </a>
    <a href="index.html" class="nav-item">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </a>
    <a href="user-profile.html" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </footer>

  <script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Get all required elements
      const uploadBtn = document.getElementById('upload-btn');
      const fileUpload = document.getElementById('file-upload');
      const cameraBtn = document.getElementById('camera-btn');
      const cameraModal = document.getElementById('camera-modal');
      const cameraView = document.getElementById('camera-view');
      const captureBtn = document.getElementById('capture-btn');
      const closeCamera = document.querySelector('.close-camera');
      const loadingScreen = document.getElementById('loading-screen');
      const imageContainer = document.getElementById('image-container');
      const selectableImage = document.getElementById('selectable-image');
      const selectionBox = document.getElementById('selection-box');
      const analyzeBtn = document.getElementById('analyze-btn');
      const resetBtn = document.getElementById('reset-btn');
      const selectionInfo = document.getElementById('selection-info');
      const selectionControls = document.getElementById('selection-controls');
      const croppedPreview = document.getElementById('cropped-preview');
      const croppedImage = document.getElementById('cropped-image');
      
      // Selection state variables
      let isSelecting = false;
      let selectionStart = { x: 0, y: 0 };
      let currentSelection = null;
      let selectedImageData = null;
      
      // Initialize event listeners
      uploadBtn.addEventListener('click', () => fileUpload.click());
      fileUpload.addEventListener('change', handleFileUpload);
      cameraBtn.addEventListener('click', openCamera);
      closeCamera.addEventListener('click', closeCameraModal);
      captureBtn.addEventListener('click', captureImage);
      analyzeBtn.addEventListener('click', analyzeSelection);
      resetBtn.addEventListener('click', resetSelection);
      
      // Camera functions
      function openCamera() {
        cameraModal.style.display = 'flex';
        
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
          }).then(function(cameraStream) {
            cameraView.srcObject = cameraStream;
          }).catch(function(error) {
            console.error("Camera Error:", error);
            alert("Could not access camera: " + error);
            closeCameraModal();
          });
        } else {
          alert("Camera not supported on this device");
          closeCameraModal();
        }
      }

      function closeCameraModal() {
        if (cameraView.srcObject) {
          cameraView.srcObject.getTracks().forEach(track => track.stop());
          cameraView.srcObject = null;
        }
        cameraModal.style.display = 'none';
      }

      function captureImage() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraView.videoWidth;
        canvas.height = cameraView.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
        
        // Convert to data URL
        const imageUrl = canvas.toDataURL('image/jpeg', 0.9);
        processImage(imageUrl);
        closeCameraModal();
      }

      // File upload handler
      function handleFileUpload(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            processImage(event.target.result);
          };
          reader.onerror = function() {
            alert("Failed to load image file");
          };
          reader.readAsDataURL(file);
        }
      }

      // Process image and setup selection
      function processImage(imageData) {
        selectedImageData = imageData;
        selectableImage.src = imageData;
        
        // Wait for image to load
        selectableImage.onload = function() {
          imageContainer.style.display = 'block';
          selectionInfo.style.display = 'block';
          selectionControls.style.display = 'flex';
          resetSelection();
          setupSelectionHandlers();
        };
        
        selectableImage.onerror = function() {
          alert("Failed to load image");
        };
      }
      
      // Setup mouse/touch handlers for selection
      function setupSelectionHandlers() {
        // Clear previous event listeners
        selectableImage.removeEventListener('mousedown', startSelection);
        selectableImage.removeEventListener('mousemove', updateSelection);
        selectableImage.removeEventListener('mouseup', endSelection);
        selectableImage.removeEventListener('touchstart', handleTouchStart);
        selectableImage.removeEventListener('touchmove', handleTouchMove);
        selectableImage.removeEventListener('touchend', handleTouchEnd);
        
        // Mouse events
        selectableImage.addEventListener('mousedown', startSelection);
        selectableImage.addEventListener('mousemove', updateSelection);
        selectableImage.addEventListener('mouseup', endSelection);
        
        // Touch events
        selectableImage.addEventListener('touchstart', handleTouchStart, { passive: false });
        selectableImage.addEventListener('touchmove', handleTouchMove, { passive: false });
        selectableImage.addEventListener('touchend', handleTouchEnd);
      }
      
      function startSelection(e) {
        // Check if this is a touch event
        const isTouch = e.type === 'touchstart';
        const event = isTouch ? e.touches[0] : e;
        
        // Prevent default for touch events to prevent scrolling
        if (isTouch) {
          e.preventDefault();
        }
        
        const pos = getEventPosition(event);
        isSelecting = true;
        selectionStart = { x: pos.x, y: pos.y };
        currentSelection = { ...selectionStart, width: 0, height: 0 };
        updateSelectionBox();
        croppedPreview.style.display = 'none';
      }
      
      function updateSelection(e) {
        if (!isSelecting) return;
        
        // Check if this is a touch event
        const isTouch = e.type === 'touchmove';
        const event = isTouch ? e.touches[0] : e;
        
        // Prevent default for touch events to prevent scrolling
        if (isTouch) {
          e.preventDefault();
        }
        
        const pos = getEventPosition(event);
        currentSelection.width = pos.x - selectionStart.x;
        currentSelection.height = pos.y - selectionStart.y;
        updateSelectionBox();
      }
      
      function endSelection(e) {
        if (!isSelecting) return;
        
        // Check if this is a touch event
        const isTouch = e.type === 'touchend';
        const event = isTouch ? e.changedTouches[0] : e;
        
        const pos = getEventPosition(event);
        currentSelection.width = pos.x - selectionStart.x;
        currentSelection.height = pos.y - selectionStart.y;
        
        // Validate selection size
        if (Math.abs(currentSelection.width) < 50 || Math.abs(currentSelection.height) < 50) {
          alert("Please select a larger area (minimum 50x50 pixels)");
          resetSelection();
          return;
        }
        
        isSelecting = false;
        analyzeBtn.disabled = false;
        selectionInfo.textContent = "Selection ready - click 'Analyze Text' to proceed";
      }
      
      // Touch event handlers
      function handleTouchStart(e) {
        startSelection(e);
      }
      
      function handleTouchMove(e) {
        updateSelection(e);
      }
      
      function handleTouchEnd(e) {
        endSelection(e);
      }
      
      // Get position from mouse or touch event
      function getEventPosition(e) {
        const rect = selectableImage.getBoundingClientRect();
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }
      
      // Update the visual selection box
      function updateSelectionBox() {
        if (!currentSelection) return;
        
        selectionBox.style.left = (currentSelection.width < 0 ? 
          selectionStart.x + currentSelection.width : selectionStart.x) + 'px';
        selectionBox.style.top = (currentSelection.height < 0 ? 
          selectionStart.y + currentSelection.height : selectionStart.y) + 'px';
        selectionBox.style.width = Math.abs(currentSelection.width) + 'px';
        selectionBox.style.height = Math.abs(currentSelection.height) + 'px';
        selectionBox.style.display = 'block';
      }
      
      // Reset the selection
      function resetSelection() {
        isSelecting = false;
        currentSelection = null;
        selectionBox.style.display = 'none';
        analyzeBtn.disabled = true;
        croppedPreview.style.display = 'none';
        selectionInfo.textContent = "Select the ingredients list area by dragging on the image";
      }
      
      // Analyze the selected area
      function analyzeSelection() {
        if (!currentSelection || !selectedImageData) {
          alert("Please select an area first");
          return;
        }

        // Crop the selected area
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Calculate actual selection coordinates
          const scaleX = img.naturalWidth / img.width;
          const scaleY = img.naturalHeight / img.height;
          
          const x = currentSelection.width < 0 ? 
            (selectionStart.x + currentSelection.width) * scaleX : 
            selectionStart.x * scaleX;
            
          const y = currentSelection.height < 0 ? 
            (selectionStart.y + currentSelection.height) * scaleY : 
            selectionStart.y * scaleY;
            
          const width = Math.abs(currentSelection.width) * scaleX;
          const height = Math.abs(currentSelection.height) * scaleY;
          
          // Set canvas dimensions to selection size
          canvas.width = width;
          canvas.height = height;
          
          // Draw the selected portion
          ctx.drawImage(
            img,
            x, y, width, height, // source rectangle
            0, 0, width, height  // destination rectangle
          );
          
          // Display the cropped image (for demonstration)
          croppedImage.src = canvas.toDataURL('image/jpeg');
          croppedPreview.style.display = 'block';
          
          // Show loading screen
          loadingScreen.style.display = 'flex';
          
          // After 3 seconds, redirect to results page
          setTimeout(function() {
            localStorage.setItem('scannedImage', selectedImageData);
            window.location.href = 'results.html';
          }, 3000);
        };
        
        img.src = selectedImageData;
      }
    });
  </script>
</body>
</html>